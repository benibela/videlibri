<?xml version="1.0" encoding="UTF-8"?>
<actions>

<meta>
  <description>Template für das VuFind-System</description>
  <variable name="baseurl"><description>Web-URI der Bibliothek (inklusive Protokoll)</description></variable>
  <variable name="loginParams"><description>Eventuell benötigte zusätzliche Parameter für den Login</description></variable>
  
</meta>


<action id="connect">
  <s>accounturl := $baseurl || "/MyResearch/"</s>
</action>

<action id="internal-login"> 
  <if test="not(get('loggedIn', false()))">
    <page url="{$accounturl}/UserLogin"/>
    <pattern><form t:condition="(@id,@name)='loginForm'">
      {$form := form(., ({"username": $username, "password": $password}, get("loginParams",())[1]))}
    </form></pattern>
    <page url="{$form}"/>
    <pattern><body><div class="alert alert-danger">{
    string() ! (if (matches(., "Ungültige Login-?angaben")) then vl:raise-login(.)
    else vl:raise(.))
    }</div>?</body></pattern>
    <s>loggedIn := true()</s>
  </if>
</action>

<action id="update-all">
  <call action="internal-login"/>
  <s>vl:delete-current-books()</s>
  <page url="{$accounturl}/CheckedOut" templateFile="list"/>
  <page url="{$accounturl}/Holds" templateFile="list"/>
</action>

<action id="renew-list">
  <s>form := request-combine({"url": x"{$accounturl}/CheckedOut", "method": "POST"}, ($renew-books!{"renewSelectedIDS[]": .("_renewID")}, "renewSelected=1", "confirm=1")  )</s>
  <page url="{$form}"/>
  <call action="update-all"/>
</action>

<action id="cancel-list">
  <s>form := request-combine({"url": x"{$accounturl}/Holds", "method": "POST"}, ($cancel-books!{"cancelSelectedIDS[]": .("_cancelID")}, "cancelSelected=1", "confirm=1")  )</s>
  <page url="{$form}"/>
  <call action="update-all"/>
</action>

<action id="search-connect">
  <call action="connect"/>
  <s>searchurl := $baseurl || "/Search/"</s>
  <!--possible: alternative, opensearch and append &view=rss but it lacks some info-->
  <page url="{$searchurl}/Advanced"/>
  <pattern>
    <form t:condition="contains(@action, 'Search/Results')">
      {$search-branches := $search-branch-values := (), 
       $search-branch-id:=0,
       $search-request := {"url": resolve-html(@action) || "?", "method": (@method, "GET")[1]},
       $daterange := (.//input[@name = "daterange[]"]/@value, "publishDate")[1]
       }
      <select t:condition="@id=('limit_collection', 'limit_mega_collection')">
       {search-branches := option, search-branch-values := option/@value}
      </select>?
    </form>
  </pattern>
</action>

<action id="search">
  <s>
    page := 1,
    search-keys := {"author": "Author", "title": "Title", "keywords": "Subject", "isbn": "ISN"},
    search-next-page := request-combine($search-request, (
      "sort=relevance",
      "join=AND",
      {"bool0[]": "AND"},
      for $key in jn:keys($book) where boolean($book($key)) and exists($search-keys($key)) return
        {"lookfor0[]": $book($key), "type0[]": $search-keys($key)},
      if (boolean($book.year)) then 
        if (contains($book.year, "-")) then 
          ({"daterange[]": $daterange}, {
            $daterange || "from": substring-before($book.year, "-"), 
            $daterange || "to": substring-after($book.year, "-") })
        else {"lookfor0[]": $book.year, "type0[]": "year"}
      else (),
      $search-branch-values[$search-branch-id] ! {"filter[]": .}
     ))
  </s>
  <call action="search-internal-vufind"/>
<!--  <s>book:={"title": "test", "holdings": {"libraryBranch":  "Lesesaal 3. Etage ", "_orderUrl": "/Record/003307385/Hold?id=003307385&item_id=DUE50003307385000010&hashKey=38685b4a112ecf8943b12c8660e2d3e5"}}</s>-->

</action>

<action id="search-next-page"> 
  <call action="search-internal-vufind"/>
</action>

<action id="search-internal-vufind">
  <page url="{$search-next-page}" templateFile="searchList"/>
  <if test="$singleMode">
    <page url="{$baseurl}/Record/{$singleModeRecordId}" templateFile="searchDetails" />
  </if>
  <else>
  <try>
    <s>item-statuses := (), params := join( $new-books/_recordId ! ("id%5B%5D="||.), $amp) </s>
    <page url="{$baseurl}/AJAX/JSON?method=getItemStatuses&{$params}">
      <header>Accept: application/json,*/*</header>
      <template><t:s>let $answer := json($raw) return $item-statuses := $answer.data()</t:s></template>
    </page>
    <catch errors="*"/>
  </try>
  <s>$page := $page + 1,
     for $b in $new-books 
     let $id := $b._recordId
     let $status := $item-statuses[id = $id][not(missing_data = true())][1]
     return $book := if (empty($status)) then $b else {| 
       $b, 
       $status!{"statusId": switch (availability)
               case "true" return "available"
               case "false" return "lend"
               default return "virtual"},
       $status.callnumber[.]!{"id": .}
     |}
  </s>
  </else>
</action>

<action id="search-details">
  <page url="{$baseurl}/Record/{$book._recordId}" templateFile="searchDetails" />
</action>




<action id="order-single">
  <call action="internal-login"/>
  <if test="matches($holding._orderUrl, 'Holdings.*login')">
    <page url="{$holding._orderUrl}"> </page>
    <pattern><t:s>$holding._orderUrl := .//a/@href[contains(., "Hold?")]</t:s></pattern>
  </if>
  <page url="{$holding._orderUrl}" templateFile="orderConfirmation"> </page>
</action>

<action id="internal-order-location">
  <if test="not( $choose-result instance of xs:decimal and $choose-result eq 0 )">
    <s>$form := request-combine($form, {"gatheredDetails[pickUpLocation]": $choose-result}),
       $confirm-result := true()
    </s>
    <call action="internal-order-confirmed"/>
  </if>
</action>

<action id="internal-order-confirmed">
  <if test="$confirm-result">
    <page url="{$form}"/>
    <pattern>
      <t:switch prioritized="true">
        <div class="alert-success">{$book.status := "ordered"}</div>
        <div class="alert-danger">{vl:raise(.)}</div>
        <div class="alert-info">{$book.status := "ordered"}</div>
      </t:switch>  
    </pattern>
  </if>
</action>

<action id="catalogue">
  <variable name="url" value="{$baseurl}"/>
</action>



</actions>
